{
  "hash": "23ede845cd73f6f1bd8d77ad3ba1b6b9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Variation by Climate\"\nformat: html\n---\n\n\n\n\n\n\n**Purpose:** Quantify the effect of interannual variation in climatic conditions (water availability) on spatialy variability in headwater flow regimes. \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n## Data\n\nSite information\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsiteinfo <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Data/EcoDrought_SiteInformation.csv\")\nsiteinfo_sp <- st_as_sf(siteinfo, coords = c(\"long\", \"lat\"), crs = 4326)\n```\n:::\n\n\n\n\n\n\nLittle g's (headwater sites)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_clean <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/LittleG_data_clean.csv\")\n```\n:::\n\n\n\n\n\n\nBig G's (reference gages)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_clean_big <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/BigG_data_clean.csv\")\n```\n:::\n\n\n\n\n\n\n\nWater availability. In western, snowmelt-dominated basins, annual (water year) total yield is strongly related to summer total yield. But in eastern, rain-dominated basins, the relationship is much weaker, suggesting \"faster\" response to climate forcing in rain-dominated basins. Use total summer yield (percentile) as metric of interannual variation in water availability.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwateravail <- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Qualitative/BigG_wateravailability_annual.csv\") %>%\n  filter(!is.na(totalyield), !is.na(totalyield_sum)) %>%\n  group_by(site_name) %>%\n  mutate(tyz_perc = percentile(totalyield_z),\n         tyz_sum_perc = percentile(totalyield_sum_z)) %>%\n  mutate(tyz_perc = ifelse(is.na(tyz_perc), 0, tyz_perc),\n         tyz_sum_perc = ifelse(is.na(tyz_sum_perc), 0, tyz_sum_perc))\n\nwateravail %>% \n  filter(basin != \"Piney River\") %>%\n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\", basin)) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Staunton River\", \"Paine Run\", \"Flathead\", \"Yellowstone River\", \"Snake River\", \"Donner Blitzen\"))) %>%\n  ggplot(aes(x = tyz_perc, y = tyz_sum_perc)) + \n  geom_point() + \n  geom_smooth(method = \"lm\") +\n  xlab(\"Total annual yield (percentile)\") + ylab(\"Total summer yield (percentile)\") + \n  facet_wrap(~basin) + theme_bw()\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\nOrder sites\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwborder <- c(\"West Brook NWIS\", \"West Brook Lower\", \"Mitchell Brook\", \"Jimmy Brook\", \"Obear Brook Lower\", \"West Brook Upper\", \"West Brook Reservoir\", \"Sanderson Brook\", \"Avery Brook\", \"West Whately Brook\")\npaineorder <- c(\"Paine Run 10\", \"Paine Run 08\", \"Paine Run 07\", \"Paine Run 06\", \"Paine Run 02\", \"Paine Run 01\")\nstauntorder <- c(\"Staunton River 10\", \"Staunton River 09\", \"Staunton River 07\", \"Staunton River 06\", \"Staunton River 03\", \"Staunton River 02\")\nflatorder <- c(\"BigCreekLower\", \"LangfordCreekLower\", \"LangfordCreekUpper\", \"Big Creek NWIS\", \"BigCreekUpper\", \"HallowattCreekLower\", \"NicolaCreek\", \"WernerCreek\", \"Hallowat Creek NWIS\", \"CoalCreekLower\", \"CycloneCreekLower\", \"CycloneCreekMiddle\", \"CycloneCreekUpper\", \"CoalCreekMiddle\", \"CoalCreekNorth\", \"CoalCreekHeadwaters\", \"McGeeCreekLower\", \"McGeeCreekTrib\", \"McGeeCreekUpper\")\nyellorder <- c(\"Shields River Valley Ranch\", \"Deep Creek\", \"Crandall Creek\", \"Buck Creek\", \"Dugout Creek\", \"Shields River ab Dugout\", \"Lodgepole Creek\", \"EF Duck Creek be HF\", \"EF Duck Creek ab HF\", \"Henrys Fork\")\nsnakeorder <- c(\"Spread Creek Dam\", \"Rock Creek\", \"NF Spread Creek Lower\", \"NF Spread Creek Upper\", \"Grizzly Creek\", \"SF Spread Creek Lower\", \"Grouse Creek\", \"SF Spread Creek Upper\", \"Leidy Creek Mouth\")\ndonnerorder <- c(\"Fish Creek NWIS\", \"Donner Blitzen ab Fish NWIS\", \"Donner Blitzen nr Burnt Car NWIS\", \"Donner Blitzen ab Indian NWIS\")\n```\n:::\n\n\n\n\n\n\n\nGet catchment shapefiles\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsheds_list <- list()\nmyfiles <- list.files(path = \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/\", pattern = \".shp\")\nfor (i in 1:length(myfiles)) {\n  sheds_list[[i]] <- st_read(paste(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/\", myfiles[i], sep = \"\"))\n}\nsheds <- do.call(rbind, sheds_list) %>% \n  mutate(site_id = ifelse(site_id == \"SP01\", \"SP07\", ifelse(site_id == \"SP07\", \"SP01\", site_id))) %>%\n  left_join(siteinfo)\n#mapview(sheds %>% arrange(desc(area_sqmi)), alpha.regions = 0.2)\n```\n:::\n\n\n\n\n\n\n\n## Median summer flow\n\nPlot maps of median summer flow across years/networks\n\n::: panel-tabset\n### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"West Brook\"\norderr <- wborder\nwtryrs <- c(2020:2024)\n\n# sheds and network\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Mass_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"WBR\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Mass_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# get lakes\nlakes <- get_waterbodies(AOI = siteinfo_sp %>% filter(site_name == \"West Brook NWIS\"), buffer = 10000)\nlakes <- lakes %>% filter(gnis_name %in% c(\"Northampton Reservoir Upper\", \"Northampton Reservoir\"))\n#st_write(lakes, \"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Study area maps/lakes/lakes_WestBrook.shp\")\n\n# little g points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% wborder) %>% mutate(site_name = factor(site_name, levels = wborder))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9))\n\n# calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# calculate long-term median of summer median flow, to center color scheme\nannmed_big <- tempdat_big %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\nannmed_big <- median(annmed_big$medlogYield)\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n\n# plot it\nplotlist_wb <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_wb[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      #scale_fill_gradientn(colours = rev(hcl.colors(100, \"Zissou1\")), limits = range(annmed$medlogYield), na.value = \"grey\") +\n      #scale_fill_gradientn(colours = cet_pal(100, name = \"l16\"), limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = lakes, color = \"white\", fill = \"lightskyblue1\", linewidth = 0.7) +\n      geom_sf(data = lakes, color = \"royalblue4\", fill = \"lightskyblue1\", linewidth = 0.5) +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = 1.05, size = 5)})\n}\nggarrange(plotlist = plotlist_wb, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-8-1.png){width=864}\n:::\n:::\n\n\n\n\n\n\n\n### Paine Run\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Paine Run\"\norderr <- paineorder\nwtryrs <- c(2019:2022)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Shen_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"PA_10FL\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Shen_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# hillshade\nmyrast <- rast(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Data/Spatial data/Elevation/Shenandoah_DEM_10m_nc.tif\")\nmyrast <- mask(crop(myrast, mysheds), mysheds)\nslo <- terrain(myrast, \"slope\", unit = \"radians\") \nasp <- terrain(myrast, \"aspect\", unit = \"radians\")\nhill <- shade(slope = slo, aspect = asp, angle = 40, direction = 270)\nhilldf <- as.data.frame(hill, xy = TRUE)\n\n# little g points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% orderr)\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_pa <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_pa[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = -Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = -0.05, size = 5)})\n}\nggarrange(plotlist = plotlist_pa, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-9-1.png){width=576}\n:::\n:::\n\n\n\n\n\n\n### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Staunton River\"\norderr <- stauntorder\nwtryrs <- c(2019:2022)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Shen_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"SR_10FL\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Shen_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# little g points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% orderr)\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_st <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_st[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = 1.05, size = 5)})\n}\nggarrange(plotlist = plotlist_st, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-10-1.png){width=576}\n:::\n:::\n\n\n\n\n\n\n\n### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Flathead\"\norderr <- flatorder\nwtryrs <- c(2018:2024)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Flat_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"NFF\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Flat_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# get lakes\nlakes <- get_waterbodies(AOI = siteinfo_sp %>% filter(site_name == \"North Fork Flathead River NWIS\"), buffer = 100000)\nlakes <- st_transform(lakes, crs(mysheds))\nlakes <- st_intersection(lakes, st_as_sf(mysheds))\nlakes <- lakes %>% filter(gnis_name %in% c(\"Moose Lake\", \"Mud Lake\"))\n\n# points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% flatorder) %>% mutate(site_name = factor(site_name, levels = flatorder))\nst_geometry(mylittleg)[mylittleg$site_name == \"BigCreekUpper\"] <- st_point(c(-114.31506, 48.57672))\nst_geometry(mylittleg)[mylittleg$site_name == \"HallowattCreekLower\"] <- st_point(c(-114.31914, 48.57256))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_fl <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_fl[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = 1.05, size = 5)})\n}\nggarrange(plotlist = plotlist_fl, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-11-1.png){width=1056}\n:::\n:::\n\n\n\n\n\n\n\n### Yellowstone\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Shields River\"\norderr <- yellorder\nwtryrs <- c(2016:2020,2022:2024)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Shields_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id %in% c(\"SRS\", \"DU01\"),]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Shields_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% mutate(site_name = factor(site_name, levels = orderr)) #%>% filter(subbasin != \"Duck Creek\")\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_ye <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_ye[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = -Inf, y = -Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = -0.15, hjust = -0.05, size = 5)})\n}\nggarrange(plotlist = plotlist_ye, common.legend = TRUE, legend = \"right\", nrow = 2, ncol = 4)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-12-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n\n### Snake\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Snake River\"\norderr <- snakeorder\nwtryrs <- c(2016:2024)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Snake_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"SP11\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Snake_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# get lakes\nlakes <- get_waterbodies(AOI = siteinfo_sp %>% filter(site_name == \"Spread Creek Dam\"), buffer = 100000)\nlakes <- st_transform(lakes, crs(mysheds))\nlakes <- st_intersection(lakes, st_as_sf(mysheds))\nlakes <- lakes %>% filter(gnis_name %in% c(\"Leidy Lake\"))\n\n# points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% snakeorder) %>% mutate(site_name = factor(site_name, levels = snakeorder))\n# edit geometry to reduce overlap\nst_geometry(mylittleg)[mylittleg$site_name == \"SF Spread Creek Lower NWIS\"] <- st_point(c(-110.32226, 43.76118))\nst_geometry(mylittleg)[mylittleg$site_name == \"NF Spread Creek Lower\"] <- st_point(c(-110.3199, 43.766533))\nst_geometry(mylittleg)[mylittleg$site_name == \"Grizzly Creek\"] <- st_point(c(-110.23289, 43.77433))\nst_geometry(mylittleg)[mylittleg$site_name == \"NF Spread Creek Upper\"] <- st_point(c(-110.23405, 43.77227))\nst_geometry(mylittleg)[mylittleg$site_name == \"SF Spread Creek Upper\"] <- st_point(c(-110.31475, 43.73661))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_sn <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_sn[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = -Inf, y = -Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = -0.15, hjust = -0.05, size = 5)})\n}\nggarrange(plotlist = plotlist_sn, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-13-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n\n### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Donner Blitzen\"\norderr <- c(donnerorder, \"Donner Blitzen River nr Frenchglen NWIS\")\nwtryrs <- c(2016:2024)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Oreg_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"DBF\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Oreg_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n\n# points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% mutate(site_name = factor(site_name, levels = donnerorder))\n# edit geometry to reduce overlap\nst_geometry(mylittleg)[mylittleg$site_name == \"Donner Blitzen ab Fish NWIS\"] <- st_point(c(-118.84315, 42.75476))\nst_geometry(mylittleg)[mylittleg$site_name == \"Fish Creek\"] <- st_point(c(-118.83173, 42.75911))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup() %>%\n  bind_rows(tempdat_big %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup())\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_db <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_db[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      annotate(\"label\", x = -Inf, y = -Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = -0.15, hjust = -0.05, size = 5)})\n}\nggarrange(plotlist = plotlist_db, common.legend = TRUE, legend = \"right\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-14-1.png){width=528}\n:::\n:::\n\n\n\n\n\n:::\n\n\n## Distribution and variability\n\nCreate function to plot interannual distribution of streamflow values, annual distributions of streamflow values, and scatterplot plot of spatial streamflow heterogeneity by water availability\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nportfolioplot <- function(bas, orderr, type = c(\"interann\", \"annual\", \"scatter\"), wtryrs) {\n  # filter data\n  tempdat <- dat_clean %>% \n    filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% wtryrs) %>%\n    mutate(site_name = factor(site_name, levels = orderr))\n  nsites <- length(unique(tempdat$site_name))\n  tempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\n  varbig <- tempdat_big %>% \n    group_by(WaterYear) %>% \n    summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n              bigsd = sd(logYield),\n              bigvar = var(logYield)) %>%\n    ungroup()\n\n  # calculate total summer water availability from reference gage\n  #summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n  #wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n\n  # calculate relative variation\n  pedat <- tempdat %>% \n    group_by(basin, WaterYear) %>% \n    summarize(nsites = length(unique(site_name)),\n              littlerange = range(logYield)[2]-range(logYield)[1],\n              littlesd = sd(logYield),\n              littlevar = var(logYield)) %>% \n    ungroup() %>% \n    left_join(varbig) %>%\n    mutate(pe_range = ((littlerange-bigrange)/bigrange)*100,\n           pe_sd = ((littlesd-bigsd)/bigsd),\n           pe_var = ((littlevar-bigvar)/bigvar)) %>%\n    left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_sum_perc)) %>% \n    filter(WaterYear %in% wtryrs) %>%\n    mutate(wylab = substr(WaterYear, 3, 4))\n\n  # interannual\n  pint <- ggplot() + \n    geom_density(data = tempdat, aes(x = logYield, y = ..scaled.., color = site_name, fill = site_name), size = 0.8) +\n    scale_color_manual(values = cet_pal(nsites, name = \"i1\")) +\n    scale_fill_manual(values = alpha(cet_pal(nsites, name = \"i1\"), 0.1)) +\n    geom_density(data = tempdat_big, aes(x = logYield, y = ..scaled..), color = \"grey40\", fill = alpha(\"grey40\", 0.2), size = 0.8) +\n    xlab(\"Summer log(Yield, mm/day)\") + ylab(\"Scaled density\") +\n    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), \n                       axis.text = element_text(color = \"black\"), legend.position = \"none\")\n\n  # annual\n  pann <- ggplot() +\n    geom_density(data = tempdat, aes(x = logYield, y = ..scaled.., color = site_name, fill = site_name), size = 0.8) +\n    scale_color_manual(values = cet_pal(nsites, name = \"i1\")) +\n    scale_fill_manual(values = alpha(cet_pal(nsites, name = \"i1\"), 0.1)) +\n    geom_density(data = tempdat_big, aes(x = logYield, y = ..scaled..), color = \"grey40\", fill = alpha(\"grey40\", 0.2), size = 0.8) +\n    xlab(\"Summer log(Yield, mm/day)\") + ylab(\"Scaled density\") +\n    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),\n                       axis.text = element_text(color = \"black\"), legend.position = \"none\") +\n    facet_wrap(~factor(WaterYear, levels = as.numeric(unlist(pedat %>% arrange(totalyield_sum_z) %>% select(WaterYear)))))\n\n  # portfolio effect by water availability\n  ppew <- pedat %>% \n    ggplot(aes(x = tyz_sum_perc, y = pe_range, label = wylab)) + \n    geom_abline(slope = 0, intercept = 0, linetype = 2) +\n    geom_smooth(method = \"lm\", color = \"black\") + \n    geom_point(shape = 21, fill = \"skyblue1\", size = 3) +\n    geom_text(vjust = -0.7, color = \"grey40\") +\n    xlab(\"Water availability\") + ylab(\"Relative difference in range\") +\n    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text = element_text(color = \"black\")) +     \n    guides(color = guide_legend(title=\"Water year\")) + xlim(0,100) + ylim(-100,450)\n\n  if(type == \"interannual\") { return(pint) }\n  if(type == \"annual\") { return(pann) }\n  if(type == \"scatter\") { return(ppew) }\n  if(type == \"table\") { return(pedat) }\n}\n```\n:::\n\n\n\n\n\n\nGenerate plots\n\n\n\n\n\n\n\n\n\n\n\n\n::: panel-tabset\n##### West Brook\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndenwb\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-17-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Paine Run\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndenpa\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-18-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Staunton River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndenst\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-19-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Flathead\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndenfl\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-20-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Yellowstone\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndenye\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-21-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Snake River\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndensn\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-22-1.png){width=864}\n:::\n:::\n\n\n\n\n\n##### Donner Blitzen\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndendb\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-23-1.png){width=864}\n:::\n:::\n\n\n\n\n\n:::\n\n\n## Model heterogeneity\n\nHow does regional water availability affect spatial streamflow heterogeneity (relative difference range of streamflow values, headwaters vs. reference gages)?\n\nSet color palette\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmycols <- brewer.pal(7, \"Set2\")\n```\n:::\n\n\n\n\n\n\nSome data manipulation\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# define basin-years to keep\nkeepyears <- bind_rows(\n  tibble(basin = \"West Brook\", WaterYear = c(2020:2024)),\n  tibble(basin = \"Paine Run\", WaterYear = c(2019:2022)),\n  tibble(basin = \"Staunton River\", WaterYear = c(2019:2022)),\n  tibble(basin = \"Flathead\", WaterYear = c(2018:2024)),\n  tibble(basin = \"Shields River\", WaterYear = c(2016:2020,2022:2024)),\n  tibble(basin = \"Snake River\", WaterYear = c(2016:2024)),\n  tibble(basin = \"Donner Blitzen\", WaterYear = c(2016:2024)),\n) %>% mutate(keep = \"yes\")\n\n# standard deviation of median summer flow\n# dat_clean %>%\n#   filter(Month %in% c(7:9)) %>%\n#   group_by(basin, site_name, WaterYear) %>%\n#   summarize(medyield = median(logYield, na.rm = TRUE)) %>%\n#   ungroup() %>%\n#   group_by(basin, WaterYear) %>%\n#   summarize(sdyield = sd(medyield), nsites = n()) %>%\n#   ungroup() %>%\n#   left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n#   left_join(keepyears) %>% filter(keep == \"yes\") %>%\n#   mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n#                         ifelse(basin == \"Flathead\", \"Flathead River\", basin))) %>%\n#   mutate(basin = factor(basin, levels = c(\"West Brook\", \"Piney River\", \"Staunton River\", \"Paine Run\", \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner Blitzen\"))) %>%\n#   ggplot(aes(x = tyz_sum_perc, y = sdyield)) +\n#   geom_smooth(method = \"lm\", color = \"black\", aes(weight = nsites)) +\n#   geom_point(aes(fill = basin, size = nsites), shape = 21) +\n#   scale_fill_brewer(palette = \"Set2\") +\n#   #facet_wrap(~basin) +\n#   theme_bw() + theme(panel.grid = element_blank())\n\n\n# calculate relative difference in range as above\nmydat <- dat_clean %>% \n  filter(Month %in% c(7:9)) %>%\n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1]) %>% \n  ungroup() %>% \n  left_join(dat_clean_big %>% \n              filter(Month %in% c(7:9)) %>% \n              group_by(basin, WaterYear) %>% \n              summarize(bigrange = range(logYield)[2]-range(logYield)[1]) %>%\n              ungroup()) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange)*100) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  left_join(keepyears) %>% filter(keep == \"yes\") %>%\n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n                        ifelse(basin == \"Flathead\", \"Flathead River\", \n                               ifelse(basin == \"Donner Blitzen\", \"Donner-Blitzen River\", basin)))) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Staunton River\", \"Paine Run\", \n                                          \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner-Blitzen River\"))) \n\nmydat\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 38 × 14\n   basin     WaterYear nsites littlerange bigrange pe_range site_name totalyield\n   <fct>         <dbl>  <int>       <dbl>    <dbl>    <dbl> <chr>          <dbl>\n 1 Donner-B…      2019      4       0.332    0.583    -43.1 Donner B…       278.\n 2 Donner-B…      2020      4       0.605    0.516     17.3 Donner B…       152.\n 3 Donner-B…      2021      4       0.474    0.336     41.1 Donner B…       122.\n 4 Donner-B…      2022      4       0.741    0.597     24.0 Donner B…       125.\n 5 Flathead…      2018     18       1.82     0.783    133.  North Fo…       654.\n 6 Flathead…      2019     19       2.47     0.668    269.  North Fo…       448.\n 7 Flathead…      2020     19       3.49     1.11     214.  North Fo…       605.\n 8 Flathead…      2021     17       2.76     0.756    265.  North Fo…       483.\n 9 Flathead…      2022     16       2.76     1.11     149.  North Fo…       793.\n10 Flathead…      2023      9       1.94     0.451    331.  North Fo…       372.\n# ℹ 28 more rows\n# ℹ 6 more variables: totalyield_z <dbl>, totalyield_sum <dbl>,\n#   totalyield_sum_z <dbl>, tyz_perc <dbl>, tyz_sum_perc <dbl>, keep <chr>\n```\n\n\n:::\n:::\n\n\n\n\n\n\nShow simple linear model summary, weighted by number of sites\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lm(pe_range ~ tyz_sum_perc, data = mydat, weights = nsites))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = pe_range ~ tyz_sum_perc, data = mydat, weights = nsites)\n\nWeighted Residuals:\n    Min      1Q  Median      3Q     Max \n-503.62 -205.22  -25.09  108.84  639.45 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept)  239.1231    26.7291   8.946 1.12e-10 ***\ntyz_sum_perc  -1.8174     0.5199  -3.496  0.00127 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 262.6 on 36 degrees of freedom\nMultiple R-squared:  0.2534,\tAdjusted R-squared:  0.2327 \nF-statistic: 12.22 on 1 and 36 DF,  p-value: 0.001273\n```\n\n\n:::\n:::\n\n\n\n\n\n\nShow distribution of spatial streamflow heterogeneity by basin. Lots of structuring by basin, driven in large part by Staunton and Donner-Blitzen Rivers.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mar = c(9,4,0.5,0.5))\nboxplot(pe_range ~ basin, data = mydat, ylab = \"Spatial streamflow heterogeneity\", xlab = \"\", las = 2, col = mycols)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n### Fit model \n\nUse a random slope/random intercept mixed effects model to estimate the among-basin mean effect of regional water availability on spatial streamflow heterogeneity.\n\n**Notes:**\n\n* This regression is not weighted by number of headwater sites used to calculate spatial heterogeneity because variance decomposition using *rptR* does not support use of weights.\n* This uses z-scored x-values...using the raw percentiles leads to model convergence issues\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydat <- mydat %>% mutate(z_tyz_sum_perc = scale(tyz_sum_perc))\nlmod <- lmer(pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin), data = mydat)\nsummary(lmod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin)\n   Data: mydat\n\nREML criterion at convergence: 430.4\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-1.5512 -0.4206 -0.1253  0.2584  2.8102 \n\nRandom effects:\n Groups   Name           Variance Std.Dev. Corr \n basin    (Intercept)    7810.1   88.37         \n          z_tyz_sum_perc  609.8   24.69    -0.92\n Residual                5127.9   71.61         \nNumber of obs: 38, groups:  basin, 7\n\nFixed effects:\n               Estimate Std. Error     df t value Pr(>|t|)  \n(Intercept)      133.13      35.60   5.51   3.740   0.0113 *\nz_tyz_sum_perc   -45.39      16.29   3.62  -2.787   0.0554 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr)\nz_tyz_sm_pr -0.521\n```\n\n\n:::\n:::\n\n\n\n\n\n\nGet p-values for global slope and intercept: (doesn't to run in Quarto...works fine in R)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(summary(as_lmerModLmerTest(lmod)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                Estimate Std. Error       df   t value   Pr(>|t|)\n(Intercept)    133.13376   35.60169 5.510014  3.739534 0.01125212\nz_tyz_sum_perc -45.39251   16.28830 3.620345 -2.786817 0.05538425\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\nPlot relationship between spatial streamflow heterogeneity and regional water availability with global (among-population mean) regression line. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get predicted values and 95% credible interval\neffects_tyz <- effects::effect(term = \"z_tyz_sum_perc\", mod = as_lmerModLmerTest(lmod), xlevels = list(z_tyz_sum_perc = seq(min(mydat$z_tyz_sum_perc), max(mydat$z_tyz_sum_perc), length.out = 1000)), se = list(level = 0.95))\nx_tyz <- as_tibble(effects_tyz) %>% mutate(tyz_sum_perc = (z_tyz_sum_perc * attr(mydat$z_tyz_sum_perc, \"scaled:scale\")) + attr(mydat$z_tyz_sum_perc, \"scaled:center\"))\n\n# trim data for panel labesl\nmydat_labs <- bind_rows(mydat %>% filter(basin == \"West Brook\", WaterYear %in% c(2020,2021)),\n                        mydat %>% filter(basin == \"Snake River\", WaterYear %in% c(2021,2022))) %>%\n  mutate(labs = c(\"b\", \"c\", \"d\", \"e\"))\n\n# plot \nrandiffplot <- ggplot() + \n  geom_ribbon(data = x_tyz, aes(x = tyz_sum_perc, ymin = lower, ymax = upper), fill = \"grey80\") +\n  geom_line(data = x_tyz, aes(x = tyz_sum_perc, y = fit), color = \"black\", size = 1.25, lineend = \"round\") +\n  geom_point(data = mydat, aes(x = tyz_sum_perc, y = pe_range, fill = basin, size = nsites), shape = 21) + \n  scale_fill_brewer(palette = \"Set2\") +\n  geom_text(data = mydat_labs, aes(x = tyz_sum_perc, y = pe_range, label = labs), size = 3) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\")) +\n  ylab(\"Spatial streamflow heterogeneity (percent difference)\") + xlab(\"Water availability (percentile)\") +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5), order = 1), size = guide_legend(title = \"Number of sites\", order = 2)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\")\nrandiffplot\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-30-1.png){width=480}\n:::\n\n```{.r .cell-code}\n# write to file\n# jpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_RangeDiff_allsites2.jpg\", width = 4.75, height = 5, units = \"in\", res = 1000)\n# randiffplot\n# dev.off()\n```\n:::\n\n\n\n\n\n\nUse *rptR* to decompose variance in spatial streamflow heterogeneity into fixed (regional water availability) and random (basin) effect sources:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrmod <- rptGaussian(pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin), data = mydat, grname = c(\"basin\", \"Fixed\"), ratio = TRUE, adjusted = FALSE, nboot = 1000)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBootstrap Progress:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(rmod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\nRepeatability estimation using the lmm method \n\nRepeatability for basin\nR  = 0.539\nSE = 0.171\nCI = [0.16, 0.813]\nP  = 0.00764 [LRT]\n     NA [Permutation]\n\nRepeatability for Fixed\nR  = 0.132\nSE = 0.101\nCI = [0.013, 0.392]\nP  = NA [LRT]\n     NA [Permutation]\n```\n\n\n:::\n\n```{.r .cell-code}\nrmod$mod\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML ['lmerMod']\nFormula: pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin)\n   Data: data\nREML criterion at convergence: 430.4229\nRandom effects:\n Groups   Name           Std.Dev. Corr \n basin    (Intercept)    88.37         \n          z_tyz_sum_perc 24.69    -0.92\n Residual                71.61         \nNumber of obs: 38, groups:  basin, 7\nFixed Effects:\n   (Intercept)  z_tyz_sum_perc  \n        133.13          -45.39  \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(rmod, grname = \"basin\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-31-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplot(rmod, grname = \"Fixed\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-31-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\nThe strong effect of basin is largely driven by Staunton and Donner-Blitzen Rivers. Without those basins, random effect variance shrinks and fixed effect variance expands considerably. Much of this pattern is likely due to low sample sizes (few headwater gages in these basins, particularly in the Donner-Blitzen)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrmod <- rptGaussian(pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin), data = mydat %>% filter(!basin %in% c(\"Staunton River\", \"Donner-Blitzen River\")), grname = c(\"basin\", \"Fixed\"), ratio = TRUE, adjusted = FALSE, nboot = 1000)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nBootstrap Progress:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(rmod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\nRepeatability estimation using the lmm method \n\nRepeatability for basin\nR  = 0.037\nSE = 0.114\nCI = [0, 0.409]\nP  = 1 [LRT]\n     NA [Permutation]\n\nRepeatability for Fixed\nR  = 0.304\nSE = 0.128\nCI = [0.066, 0.563]\nP  = NA [LRT]\n     NA [Permutation]\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n### Sensitivity analysis\n\nHow sensitive are these results to the choice of data (log) transformation, per comments from John Hammond during USGS internal review?\n\nSummary: While the among-network mean effect of water availability on heterogeneity was less significant using un-logged discharge data (p > 0.05), this appeared to be driven by the highly non-normal distribution of raw discharge values, as the reviewer indicated. Importantly, the magnitude of the effect is similar and the qualitative results are unchanged (negative slope). \n\nData manipulation: use un-logged/raw Yield data to calculation spatial heterogeneity, also use CV rather than ranges\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydat2 <- dat_clean %>% \n  filter(Month %in% c(7:9)) %>%\n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(Yield_mm)[2]-range(Yield_mm)[1],\n            littlecv = sd(Yield_mm)/mean(Yield_mm)) %>% \n  ungroup() %>% \n  left_join(dat_clean_big %>% \n              filter(Month %in% c(7:9)) %>% \n              group_by(basin, WaterYear) %>% \n              summarize(bigrange = range(Yield_mm)[2]-range(Yield_mm)[1],\n                        bigcv = sd(Yield_mm)/mean(Yield_mm)) %>%\n              ungroup()) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange)*100,\n         pe_cv = ((littlecv-bigcv)/bigcv)*100) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield:tyz_sum_perc)) %>%\n  left_join(keepyears) %>% filter(keep == \"yes\") %>%\n  mutate(basin = ifelse(basin == \"Shields River\", \"Yellowstone River\",\n                        ifelse(basin == \"Flathead\", \"Flathead River\", \n                               ifelse(basin == \"Donner Blitzen\", \"Donner-Blitzen River\", basin)))) %>%\n  mutate(basin = factor(basin, levels = c(\"West Brook\", \"Staunton River\", \"Paine Run\", \n                                          \"Flathead River\", \"Yellowstone River\", \"Snake River\", \"Donner-Blitzen River\"))) \n```\n:::\n\n\n\n\n\n\n\n#### Range, un-logged\n\nFit the mixed effects model\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydat2 <- mydat2 %>% mutate(z_tyz_sum_perc = scale(tyz_sum_perc))\nlmod <- lmer(pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin), data = mydat2)\nsummary(lmod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: pe_range ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin)\n   Data: mydat2\n\nREML criterion at convergence: 523.5\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-1.8092 -0.4147 -0.1069  0.3663  3.7590 \n\nRandom effects:\n Groups   Name           Variance Std.Dev. Corr \n basin    (Intercept)    79567    282.1         \n          z_tyz_sum_perc 19495    139.6    -1.00\n Residual                70913    266.3         \nNumber of obs: 38, groups:  basin, 7\n\nFixed effects:\n               Estimate Std. Error      df t value Pr(>|t|)\n(Intercept)     238.131    116.273   4.215   2.048    0.106\nz_tyz_sum_perc  -86.826     72.670   2.761  -1.195    0.325\n\nCorrelation of Fixed Effects:\n            (Intr)\nz_tyz_sm_pr -0.703\noptimizer (nloptwrap) convergence code: 0 (OK)\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n:::\n\n\n\n\n\n\nPlot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get predicted values and 95% credible interval\neffects_tyz <- effects::effect(term = \"z_tyz_sum_perc\", mod = as_lmerModLmerTest(lmod), xlevels = list(z_tyz_sum_perc = seq(min(mydat2$z_tyz_sum_perc), max(mydat2$z_tyz_sum_perc), length.out = 1000)), se = list(level = 0.95))\nx_tyz <- as_tibble(effects_tyz) %>% mutate(tyz_sum_perc = (z_tyz_sum_perc * attr(mydat2$z_tyz_sum_perc, \"scaled:scale\")) + attr(mydat2$z_tyz_sum_perc, \"scaled:center\"))\n\n# trim data for panel labesl\nmydat_labs <- bind_rows(mydat2 %>% filter(basin == \"West Brook\", WaterYear %in% c(2020,2021)),\n                        mydat2 %>% filter(basin == \"Snake River\", WaterYear %in% c(2021,2022))) %>%\n  mutate(labs = c(\"b\", \"c\", \"d\", \"e\"))\n\n# plot \nggplot() + \n  geom_ribbon(data = x_tyz, aes(x = tyz_sum_perc, ymin = lower, ymax = upper), fill = \"grey80\") +\n  geom_line(data = x_tyz, aes(x = tyz_sum_perc, y = fit), color = \"black\", size = 1.25, lineend = \"round\") +\n  geom_point(data = mydat2, aes(x = tyz_sum_perc, y = pe_range, fill = basin, size = nsites), shape = 21) + \n  scale_fill_brewer(palette = \"Set2\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\")) +\n  ylab(\"Spatial streamflow heterogeneity (percent difference)\") + xlab(\"Water availability (percentile)\") +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5), order = 1), size = guide_legend(title = \"Number of sites\", order = 2)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n#### CV\n\nFig the mmixed effects model\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmydat2 <- mydat2 %>% mutate(z_tyz_sum_perc = scale(tyz_sum_perc))\nlmod <- lmer(pe_cv ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin), data = mydat2)\nsummary(lmod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: pe_cv ~ z_tyz_sum_perc + (1 + z_tyz_sum_perc | basin)\n   Data: mydat2\n\nREML criterion at convergence: 450.7\n\nScaled residuals: \n    Min      1Q  Median      3Q     Max \n-2.4210 -0.3359  0.0006  0.2983  3.9794 \n\nRandom effects:\n Groups   Name           Variance Std.Dev. Corr \n basin    (Intercept)    24752    157.33        \n          z_tyz_sum_perc  8948     94.59   -1.00\n Residual                 7991     89.39        \nNumber of obs: 38, groups:  basin, 7\n\nFixed effects:\n               Estimate Std. Error      df t value Pr(>|t|)\n(Intercept)      88.405     61.551   5.248   1.436    0.208\nz_tyz_sum_perc  -55.189     39.739   3.675  -1.389    0.243\n\nCorrelation of Fixed Effects:\n            (Intr)\nz_tyz_sm_pr -0.889\noptimizer (nloptwrap) convergence code: 0 (OK)\nboundary (singular) fit: see help('isSingular')\n```\n\n\n:::\n:::\n\n\n\n\n\n\nPlot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get predicted values and 95% credible interval\neffects_tyz <- effects::effect(term = \"z_tyz_sum_perc\", mod = as_lmerModLmerTest(lmod), xlevels = list(z_tyz_sum_perc = seq(min(mydat2$z_tyz_sum_perc), max(mydat2$z_tyz_sum_perc), length.out = 1000)), se = list(level = 0.95))\nx_tyz <- as_tibble(effects_tyz) %>% mutate(tyz_sum_perc = (z_tyz_sum_perc * attr(mydat2$z_tyz_sum_perc, \"scaled:scale\")) + attr(mydat2$z_tyz_sum_perc, \"scaled:center\"))\n\n# trim data for panel labesl\nmydat_labs <- bind_rows(mydat2 %>% filter(basin == \"West Brook\", WaterYear %in% c(2020,2021)),\n                        mydat2 %>% filter(basin == \"Snake River\", WaterYear %in% c(2021,2022))) %>%\n  mutate(labs = c(\"b\", \"c\", \"d\", \"e\"))\n\n# plot \nggplot() + \n  geom_ribbon(data = x_tyz, aes(x = tyz_sum_perc, ymin = lower, ymax = upper), fill = \"grey80\") +\n  geom_line(data = x_tyz, aes(x = tyz_sum_perc, y = fit), color = \"black\", size = 1.25, lineend = \"round\") +\n  geom_point(data = mydat2, aes(x = tyz_sum_perc, y = pe_cv, fill = basin, size = nsites), shape = 21) + \n  scale_fill_brewer(palette = \"Set2\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\")) +\n  ylab(\"Spatial streamflow heterogeneity (percent difference)\") + xlab(\"Water availability (percentile)\") +\n  guides(fill = guide_legend(title = \"Basin\", override.aes = list(size = 5), order = 1), size = guide_legend(title = \"Number of sites\", order = 2)) +\n  geom_abline(intercept = 0, slope = 0, linetype = \"dashed\")\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## Paper figs\n\n### West Brook\n\n2020/2021 summer flow distributions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"West Brook\"\norderr <- wborder\nwtryrs <- c(2020,2021)\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% wtryrs) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\n\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n# annual\npann <- ggplot() +\n  geom_density(data = tempdat, aes(x = logYield, y = ..scaled.., color = site_name, fill = site_name), size = 0.8) +\n  scale_color_manual(values = cet_pal(nsites, name = \"i1\")) +\n  scale_fill_manual(values = alpha(cet_pal(nsites, name = \"i1\"), 0.1)) +\n  geom_density(data = tempdat_big, aes(x = logYield, y = ..scaled..), color = \"grey40\", fill = alpha(\"grey40\", 0.2), size = 0.8) +\n  xlab(\"Summer log(Yield, mm/day)\") + ylab(\"Density\") +\n  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), \n                     axis.text.y = element_blank(), axis.ticks.y = element_blank(),\n                     axis.text = element_text(color = \"black\"), legend.position = \"none\",\n                     strip.background = element_blank(), strip.text = element_blank()) +\n  facet_wrap(~factor(WaterYear, levels = as.numeric(unlist(pedat %>% arrange(totalyield_sum_z) %>% select(WaterYear)))), ncol = 1)\n\nprint(pann)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-38-1.png){width=264}\n:::\n\n```{.r .cell-code}\n# jpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_summerdensity_WB_annual.jpg\", width = 2.75, height = 5, units = \"in\", res = 1000)\n# pann\n# dev.off()\n```\n:::\n\n\n\n\n\n\n2020/2021 summer flow distributions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"West Brook\"\norderr <- wborder\nwtryrs <- c(2020,2021)\n\n# sheds and network\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Mass_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"WBR\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Mass_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# get lakes\nlakes <- get_waterbodies(AOI = siteinfo_sp %>% filter(site_name == \"West Brook NWIS\"), buffer = 10000)\nlakes <- lakes %>% filter(gnis_name %in% c(\"Northampton Reservoir Upper\", \"Northampton Reservoir\"))\n\n# little g points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% wborder) %>% mutate(site_name = factor(site_name, levels = wborder))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_wb <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_wb[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = lakes, color = \"white\", fill = \"lightskyblue1\", linewidth = 0.7) +\n      geom_sf(data = lakes, color = \"royalblue4\", fill = \"lightskyblue1\", linewidth = 0.5) +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      theme_void() + scale_x_continuous(expand = c(0.003, 0.003)) + scale_y_continuous(expand = c(0.002, 0.002))\n      #annotate(\"label\", x = Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = 1.05, size = 5)\n      })\n}\np <- ggarrange(plotlist = plotlist_wb, common.legend = TRUE, legend = \"right\", nrow = 2)\nprint(p)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-39-1.png){width=384}\n:::\n\n```{.r .cell-code}\n# jpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_summermedianmap_WB_annual.jpg\", width = 4, height = 6, units = \"in\", res = 1000)\n# p\n# dev.off()\n```\n:::\n\n\n\n\n\n\n\n### Snake River\n\n2021/2022 summer flow distributions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Snake River\"\norderr <- snakeorder\nwtryrs <- c(2021,2022)\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% wtryrs) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\n\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n# annual\npann <- ggplot() +\n  geom_density(data = tempdat, aes(x = logYield, y = ..scaled.., color = site_name, fill = site_name), size = 0.8) +\n  scale_color_manual(values = cet_pal(nsites, name = \"i1\")) +\n  scale_fill_manual(values = alpha(cet_pal(nsites, name = \"i1\"), 0.1)) +\n  geom_density(data = tempdat_big, aes(x = logYield, y = ..scaled..), color = \"grey40\", fill = alpha(\"grey40\", 0.2), size = 0.8) +\n  xlab(\"Summer log(Yield, mm/day)\") + ylab(\"Density\") +\n  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), \n                     axis.text.y = element_blank(), axis.ticks.y = element_blank(),\n                     axis.text = element_text(color = \"black\"), legend.position = \"none\",\n                     strip.background = element_blank(), strip.text = element_blank()) +\n  facet_wrap(~factor(WaterYear, levels = as.numeric(unlist(pedat %>% arrange(totalyield_sum_z) %>% select(WaterYear)))), ncol = 1)\n\nprint(pann)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-40-1.png){width=264}\n:::\n\n```{.r .cell-code}\n# jpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_summerdensity_Snake_annual.jpg\", width = 2.75, height = 5, units = \"in\", res = 1000)\n# pann\n# dev.off()\n```\n:::\n\n\n\n\n\n\n2022/2022 summer flow distributions\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbas <- \"Snake River\"\norderr <- snakeorder\nwtryrs <- c(2021,2022)\n\nmysheds <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Watersheds/Snake_Watersheds.shp\")\nmysheds <- mysheds[mysheds$site_id == \"SP11\",]\nmynet <- vect(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/EcoDrought-Analysis/Watershed Delineation/Streams/Snake_Streams.shp\")\ncrs(mynet) <- crs(mysheds)\nmynet <- crop(mynet, mysheds)\n\n# get lakes\nlakes <- get_waterbodies(AOI = siteinfo_sp %>% filter(site_name == \"Spread Creek Dam\"), buffer = 100000)\nlakes <- st_transform(lakes, crs(mysheds))\nlakes <- st_intersection(lakes, st_as_sf(mysheds))\nlakes <- lakes %>% filter(gnis_name %in% c(\"Leidy Lake\"))\n\n# points\nmylittleg <- siteinfo_sp %>% filter(site_name %in% snakeorder) %>% mutate(site_name = factor(site_name, levels = snakeorder))\n# edit geometry to reduce overlap\nst_geometry(mylittleg)[mylittleg$site_name == \"SF Spread Creek Lower NWIS\"] <- st_point(c(-110.32226, 43.76118))\nst_geometry(mylittleg)[mylittleg$site_name == \"NF Spread Creek Lower\"] <- st_point(c(-110.3199, 43.766533))\nst_geometry(mylittleg)[mylittleg$site_name == \"Grizzly Creek\"] <- st_point(c(-110.23289, 43.77433))\nst_geometry(mylittleg)[mylittleg$site_name == \"NF Spread Creek Upper\"] <- st_point(c(-110.23405, 43.77227))\nst_geometry(mylittleg)[mylittleg$site_name == \"SF Spread Creek Upper\"] <- st_point(c(-110.31475, 43.73661))\n\n\n# filter data\ntempdat <- dat_clean %>% \n  filter(basin == bas, !is.na(logYield), Month %in% c(7:9)) %>%\n  mutate(site_name = factor(site_name, levels = orderr))\nnsites <- length(unique(tempdat$site_name))\ntempdat_big <- dat_clean_big %>% filter(basin == bas, !is.na(logYield), Month %in% c(7:9), WaterYear %in% unique(tempdat$WaterYear))\n\n  # calculate variability for reference gage\nvarbig <- tempdat_big %>% \n  group_by(WaterYear) %>% \n  summarize(bigrange = range(logYield)[2]-range(logYield)[1],\n            bigsd = sd(logYield),\n            bigvar = var(logYield)) %>%\n  ungroup()\n\n# calculate total summer water availability from reference gage\n#summerflow <- tempdat_big %>% group_by(WaterYear) %>% summarize(summeryield = sum(Yield_mm), summeryield_log = log(sum(Yield_mm))) %>% ungroup()\n#wateravail2 <- wateravail %>% select(basin, WaterYear, totalyield, totalyield_z)\n\n# calculate relative variation\npedat <- tempdat %>% \n  group_by(basin, WaterYear) %>% \n  summarize(nsites = length(unique(site_name)),\n            littlerange = range(logYield)[2]-range(logYield)[1],\n            littlesd = sd(logYield),\n            littlevar = var(logYield)) %>% \n  ungroup() %>% \n  left_join(varbig) %>%\n  mutate(pe_range = ((littlerange-bigrange)/bigrange),\n         pe_sd = ((littlesd-bigsd)/bigsd),\n         pe_var = ((littlevar-bigvar)/bigvar)) %>%\n  left_join(wateravail %>% select(basin, WaterYear, totalyield, totalyield_z, totalyield_sum, totalyield_sum_z, tyz_perc, tyz_sum_perc)) %>% \n  filter(WaterYear %in% wtryrs) %>%\n  mutate(wylab = substr(WaterYear, 3, 4)) %>%\n  arrange(totalyield_sum_z)\n  \n# calculate annual median summer flow\nannmed <- tempdat %>%\n  #filter(WaterYear %in% c(lowyr, highyr)) %>%\n  group_by(site_name, WaterYear) %>%\n  summarize(medlogYield = median(logYield, na.rm = TRUE)) %>%\n  ungroup()\n\n# arrange years by total annual yield\nwtryrs_arranged <- as.numeric(unlist(pedat %>% select(WaterYear)))\n\n# plot it\nplotlist_wb <- list()\nfor(i in 1:length(wtryrs_arranged)) {\n  mylittleg <- siteinfo_sp %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i]))\n  mylittleg_sheds <- sheds %>% filter(site_name %in% orderr) %>% left_join(annmed %>% filter(WaterYear == wtryrs_arranged[i])) %>% arrange(desc(area_sqmi))\n  plotlist_wb[[i]] <- local({\n    i <- i\n    ggplot() +\n      geom_sf(data = st_as_sf(mysheds), color = \"black\", fill = \"white\", linewidth = 0.4) + \n      geom_sf(data = mylittleg_sheds, aes(fill = medlogYield), color = \"black\") +\n      scale_fill_viridis(option = \"G\", direction = 1, limits = range(annmed$medlogYield), na.value = \"grey\") +\n      geom_sf(data = st_as_sf(mynet), color = \"white\", linewidth = 1, lineend = \"round\") +\n      geom_sf(data = st_as_sf(mynet), color = \"royalblue4\", linewidth = 0.6, lineend = \"round\") +\n      geom_sf(data = lakes, color = \"white\", fill = \"lightskyblue1\", linewidth = 0.7) +\n      geom_sf(data = lakes, color = \"royalblue4\", fill = \"lightskyblue1\", linewidth = 0.5) +\n      geom_sf(data = mylittleg, shape = 21, fill = \"white\", size = 2) +\n      labs(fill = \"Median\\nsummer\\nlog(Yield)\") + #annotation_scale() +\n      coord_sf(xlim = range(st_coordinates(mylittleg_sheds)[,1]), ylim = range(st_coordinates(mylittleg_sheds)[,2])) +\n      theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = \"none\", axis.text = element_blank()) +\n      theme_void() + scale_x_continuous(expand = c(0.003, 0.003)) + scale_y_continuous(expand = c(0.002, 0.002))\n      #annotate(\"label\", x = Inf, y = Inf, label = paste(pedat$WaterYear[i], \" (\", pedat$tyz_sum_perc[i], \"%)\", sep = \"\"), vjust = 1.15, hjust = 1.05, size = 5)\n      })\n}\np <- ggarrange(plotlist = plotlist_wb, common.legend = TRUE, legend = \"right\", nrow = 2)\nprint(p)\n```\n\n::: {.cell-output-display}\n![](VarByClimate_files/figure-html/unnamed-chunk-41-1.png){width=384}\n:::\n\n```{.r .cell-code}\n# jpeg(\"C:/Users/jbaldock/OneDrive - DOI/Documents/USGS/EcoDrought/EcoDrought Working/Presentation figs/EcoD_summermedianmap_Snake_annual.jpg\", width = 4, height = 6, units = \"in\", res = 1000)\n# p\n# dev.off()\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}